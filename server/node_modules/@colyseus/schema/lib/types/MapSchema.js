"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.MapSchema = exports.getMapProxy = void 0;
var ChangeTree_1 = require("../changes/ChangeTree");
var spec_1 = require("../spec");
var Schema_1 = require("../Schema");
function getMapProxy(value) {
    value['$proxy'] = true;
    value = new Proxy(value, {
        get: function (obj, prop) {
            if (typeof (prop) !== "symbol" && // accessing properties
                typeof (obj[prop]) === "undefined") {
                return obj.get(prop);
            }
            else {
                return obj[prop];
            }
        },
        set: function (obj, prop, setValue) {
            if (typeof (prop) !== "symbol" &&
                (prop.indexOf("$") === -1 &&
                    prop !== "onAdd" &&
                    prop !== "onRemove" &&
                    prop !== "onChange")) {
                obj.set(prop, setValue);
            }
            else {
                obj[prop] = setValue;
            }
            return true;
        },
        deleteProperty: function (obj, prop) {
            obj.delete(prop);
            return true;
        },
    });
    return value;
}
exports.getMapProxy = getMapProxy;
var MapSchema = /** @class */ (function () {
    function MapSchema(initialValues) {
        var _this = this;
        this.$changes = new ChangeTree_1.ChangeTree(this);
        this.$items = new Map();
        this.$indexes = new Map();
        this.$refId = 0;
        if (initialValues) {
            if (initialValues instanceof Map) {
                initialValues.forEach(function (v, k) { return _this.set(k, v); });
            }
            else {
                for (var k in initialValues) {
                    this.set(k, initialValues[k]);
                }
            }
        }
    }
    MapSchema.is = function (type) {
        return type['map'] !== undefined;
    };
    /** Iterator */
    MapSchema.prototype[Symbol.iterator] = function () { return this.$items[Symbol.iterator](); };
    Object.defineProperty(MapSchema.prototype, Symbol.toStringTag, {
        get: function () { return this.$items[Symbol.toStringTag]; },
        enumerable: false,
        configurable: true
    });
    MapSchema.prototype.set = function (key, value) {
        // get "index" for this value.
        var hasIndex = typeof (this.$changes.indexes[key]) !== "undefined";
        var index = (hasIndex)
            ? this.$changes.indexes[key]
            : this.$refId++;
        var operation = (hasIndex)
            ? spec_1.OPERATION.REPLACE
            : spec_1.OPERATION.ADD;
        var isRef = (value['$changes']) !== undefined;
        if (isRef) {
            value['$changes'].setParent(this, this.$changes.root, index);
        }
        //
        // (encoding)
        // set a unique id to relate directly with this key/value.
        //
        if (!hasIndex) {
            this.$changes.indexes[key] = index;
            this.$indexes.set(index, key);
        }
        else if (isRef && // if is schema, force ADD operation if value differ from previous one.
            this.$items.get(key) !== value) {
            operation = spec_1.OPERATION.ADD;
        }
        this.$items.set(key, value);
        this.$changes.change(key, operation);
        return this;
    };
    MapSchema.prototype.get = function (key) {
        return this.$items.get(key);
    };
    MapSchema.prototype.delete = function (key) {
        //
        // TODO: add a "purge" method after .encode() runs, to cleanup removed `$indexes`
        //
        // We don't remove $indexes to allow setting the same key in the same patch
        // (See "should allow to remove and set an item in the same place" test)
        //
        // // const index = this.$changes.indexes[key];
        // // this.$indexes.delete(index);
        this.$changes.delete(key);
        return this.$items.delete(key);
    };
    MapSchema.prototype.clear = function (isDecoding) {
        var _this = this;
        // discard previous operations.
        this.$changes.discard(true, true);
        this.$changes.indexes = {};
        // clear previous indexes
        this.$indexes.clear();
        // flag child items for garbage collection.
        if (isDecoding && typeof (this.$changes.getType()) !== "string") {
            this.$items.forEach(function (item) {
                _this.$changes.root.removeRef(item['$changes'].refId);
            });
        }
        // clear items
        this.$items.clear();
        this.$changes.operation({ index: 0, op: spec_1.OPERATION.CLEAR });
        // touch all structures until reach root
        this.$changes.touchParents();
    };
    MapSchema.prototype.has = function (key) {
        return this.$items.has(key);
    };
    MapSchema.prototype.forEach = function (callbackfn) {
        this.$items.forEach(callbackfn);
    };
    MapSchema.prototype.entries = function () {
        return this.$items.entries();
    };
    MapSchema.prototype.keys = function () {
        return this.$items.keys();
    };
    MapSchema.prototype.values = function () {
        return this.$items.values();
    };
    Object.defineProperty(MapSchema.prototype, "size", {
        get: function () {
            return this.$items.size;
        },
        enumerable: false,
        configurable: true
    });
    MapSchema.prototype.setIndex = function (index, key) {
        this.$indexes.set(index, key);
    };
    MapSchema.prototype.getIndex = function (index) {
        return this.$indexes.get(index);
    };
    MapSchema.prototype.getByIndex = function (index) {
        return this.$items.get(this.$indexes.get(index));
    };
    MapSchema.prototype.deleteByIndex = function (index) {
        var key = this.$indexes.get(index);
        this.$items.delete(key);
        this.$indexes.delete(index);
    };
    MapSchema.prototype.toJSON = function () {
        var map = {};
        this.forEach(function (value, key) {
            map[key] = (typeof (value['toJSON']) === "function")
                ? value['toJSON']()
                : value;
        });
        return map;
    };
    //
    // Decoding utilities
    //
    MapSchema.prototype.clone = function (isDecoding) {
        var cloned;
        if (isDecoding) {
            // client-side
            cloned = Object.assign(new MapSchema(), this);
        }
        else {
            // server-side
            var cloned_1 = new MapSchema();
            this.forEach(function (value, key) {
                if (value['$changes']) {
                    cloned_1.set(key, value['clone']());
                }
                else {
                    cloned_1.set(key, value);
                }
            });
        }
        return cloned;
    };
    MapSchema.prototype.triggerAll = function () {
        Schema_1.Schema.prototype.triggerAll.apply(this);
    };
    return MapSchema;
}());
exports.MapSchema = MapSchema;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiTWFwU2NoZW1hLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc3JjL3R5cGVzL01hcFNjaGVtYS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFBQSxvREFBbUQ7QUFDbkQsZ0NBQW9DO0FBQ3BDLG9DQUEyRDtBQUkzRCxTQUFnQixXQUFXLENBQUMsS0FBZ0I7SUFDeEMsS0FBSyxDQUFDLFFBQVEsQ0FBQyxHQUFHLElBQUksQ0FBQztJQUV2QixLQUFLLEdBQUcsSUFBSSxLQUFLLENBQUMsS0FBSyxFQUFFO1FBQ3JCLEdBQUcsRUFBRSxVQUFDLEdBQUcsRUFBRSxJQUFJO1lBQ1gsSUFDSSxPQUFPLENBQUMsSUFBSSxDQUFDLEtBQUssUUFBUSxJQUFJLHVCQUF1QjtnQkFDckQsT0FBTyxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsQ0FBQyxLQUFLLFdBQVcsRUFDcEM7Z0JBQ0UsT0FBTyxHQUFHLENBQUMsR0FBRyxDQUFDLElBQWMsQ0FBQyxDQUFDO2FBRWxDO2lCQUFNO2dCQUNILE9BQU8sR0FBRyxDQUFDLElBQUksQ0FBQyxDQUFDO2FBQ3BCO1FBQ0wsQ0FBQztRQUVELEdBQUcsRUFBRSxVQUFDLEdBQUcsRUFBRSxJQUFJLEVBQUUsUUFBUTtZQUNyQixJQUNJLE9BQU8sQ0FBQyxJQUFJLENBQUMsS0FBSyxRQUFRO2dCQUMxQixDQUNLLElBQWUsQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLEtBQUssQ0FBQyxDQUFDO29CQUNwQyxJQUFJLEtBQUssT0FBTztvQkFDaEIsSUFBSSxLQUFLLFVBQVU7b0JBQ25CLElBQUksS0FBSyxVQUFVLENBQ3RCLEVBQ0g7Z0JBQ0UsR0FBRyxDQUFDLEdBQUcsQ0FBQyxJQUFjLEVBQUUsUUFBUSxDQUFDLENBQUM7YUFFckM7aUJBQU07Z0JBQ0gsR0FBRyxDQUFDLElBQUksQ0FBQyxHQUFHLFFBQVEsQ0FBQzthQUN4QjtZQUNELE9BQU8sSUFBSSxDQUFDO1FBQ2hCLENBQUM7UUFFRCxjQUFjLEVBQUUsVUFBQyxHQUFHLEVBQUUsSUFBSTtZQUN0QixHQUFHLENBQUMsTUFBTSxDQUFDLElBQWMsQ0FBQyxDQUFDO1lBQzNCLE9BQU8sSUFBSSxDQUFDO1FBQ2hCLENBQUM7S0FDSixDQUFDLENBQUM7SUFFSCxPQUFPLEtBQUssQ0FBQztBQUNqQixDQUFDO0FBekNELGtDQXlDQztBQUVEO0lBbUJJLG1CQUFhLGFBQW9DO1FBQWpELGlCQVdDO1FBN0JTLGFBQVEsR0FBZSxJQUFJLHVCQUFVLENBQUMsSUFBSSxDQUFDLENBQUM7UUFFNUMsV0FBTSxHQUFtQixJQUFJLEdBQUcsRUFBYSxDQUFDO1FBQzlDLGFBQVEsR0FBd0IsSUFBSSxHQUFHLEVBQWtCLENBQUM7UUFFMUQsV0FBTSxHQUFXLENBQUMsQ0FBQztRQWN6QixJQUFJLGFBQWEsRUFBRTtZQUNmLElBQUksYUFBYSxZQUFZLEdBQUcsRUFBRTtnQkFDOUIsYUFBYSxDQUFDLE9BQU8sQ0FBQyxVQUFDLENBQUMsRUFBRSxDQUFDLElBQUssT0FBQSxLQUFJLENBQUMsR0FBRyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsRUFBZCxDQUFjLENBQUMsQ0FBQzthQUVuRDtpQkFBTTtnQkFDSCxLQUFLLElBQU0sQ0FBQyxJQUFJLGFBQWEsRUFBRTtvQkFDM0IsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDLEVBQUUsYUFBYSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7aUJBQ2pDO2FBQ0o7U0FDSjtJQUNMLENBQUM7SUFmTSxZQUFFLEdBQVQsVUFBVSxJQUFTO1FBQ2YsT0FBTyxJQUFJLENBQUMsS0FBSyxDQUFDLEtBQUssU0FBUyxDQUFDO0lBQ3JDLENBQUM7SUFlRCxlQUFlO0lBQ2Ysb0JBQUMsTUFBTSxDQUFDLFFBQVEsQ0FBQyxHQUFqQixjQUFnRCxPQUFPLElBQUksQ0FBQyxNQUFNLENBQUMsTUFBTSxDQUFDLFFBQVEsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDO0lBQ3hGLHNCQUFJLHFCQUFDLE1BQU0sQ0FBQyxXQUFZO2FBQXhCLGNBQTZCLE9BQU8sSUFBSSxDQUFDLE1BQU0sQ0FBQyxNQUFNLENBQUMsV0FBVyxDQUFDLENBQUEsQ0FBQyxDQUFDOzs7T0FBQTtJQUVyRSx1QkFBRyxHQUFILFVBQUksR0FBTSxFQUFFLEtBQVE7UUFDaEIsOEJBQThCO1FBQzlCLElBQU0sUUFBUSxHQUFHLE9BQU0sQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsQ0FBQyxLQUFLLFdBQVcsQ0FBQztRQUNwRSxJQUFNLEtBQUssR0FBRyxDQUFDLFFBQVEsQ0FBQztZQUNwQixDQUFDLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDO1lBQzVCLENBQUMsQ0FBQyxJQUFJLENBQUMsTUFBTSxFQUFFLENBQUM7UUFFcEIsSUFBSSxTQUFTLEdBQWMsQ0FBQyxRQUFRLENBQUM7WUFDakMsQ0FBQyxDQUFDLGdCQUFTLENBQUMsT0FBTztZQUNuQixDQUFDLENBQUMsZ0JBQVMsQ0FBQyxHQUFHLENBQUM7UUFFcEIsSUFBTSxLQUFLLEdBQUcsQ0FBQyxLQUFLLENBQUMsVUFBVSxDQUFDLENBQUMsS0FBSyxTQUFTLENBQUM7UUFDaEQsSUFBSSxLQUFLLEVBQUU7WUFDTixLQUFLLENBQUMsVUFBVSxDQUFnQixDQUFDLFNBQVMsQ0FDdkMsSUFBSSxFQUNKLElBQUksQ0FBQyxRQUFRLENBQUMsSUFBSSxFQUNsQixLQUFLLENBQ1IsQ0FBQztTQUNMO1FBRUQsRUFBRTtRQUNGLGFBQWE7UUFDYiwwREFBMEQ7UUFDMUQsRUFBRTtRQUNGLElBQUksQ0FBQyxRQUFRLEVBQUU7WUFDWCxJQUFJLENBQUMsUUFBUSxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsR0FBRyxLQUFLLENBQUM7WUFDbkMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsS0FBSyxFQUFFLEdBQUcsQ0FBQyxDQUFDO1NBRWpDO2FBQU0sSUFDSCxLQUFLLElBQUksdUVBQXVFO1lBQ2hGLElBQUksQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxLQUFLLEtBQUssRUFDaEM7WUFDRSxTQUFTLEdBQUcsZ0JBQVMsQ0FBQyxHQUFHLENBQUM7U0FDN0I7UUFFRCxJQUFJLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxHQUFHLEVBQUUsS0FBSyxDQUFDLENBQUM7UUFFNUIsSUFBSSxDQUFDLFFBQVEsQ0FBQyxNQUFNLENBQUMsR0FBRyxFQUFFLFNBQVMsQ0FBQyxDQUFDO1FBRXJDLE9BQU8sSUFBSSxDQUFDO0lBQ2hCLENBQUM7SUFFRCx1QkFBRyxHQUFILFVBQUksR0FBTTtRQUNOLE9BQU8sSUFBSSxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLENBQUM7SUFDaEMsQ0FBQztJQUVELDBCQUFNLEdBQU4sVUFBTyxHQUFNO1FBQ1QsRUFBRTtRQUNGLGlGQUFpRjtRQUNqRixFQUFFO1FBQ0YsMkVBQTJFO1FBQzNFLHdFQUF3RTtRQUN4RSxFQUFFO1FBQ0YsK0NBQStDO1FBQy9DLGtDQUFrQztRQUVsQyxJQUFJLENBQUMsUUFBUSxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUMxQixPQUFPLElBQUksQ0FBQyxNQUFNLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDO0lBQ25DLENBQUM7SUFFRCx5QkFBSyxHQUFMLFVBQU0sVUFBb0I7UUFBMUIsaUJBc0JDO1FBckJHLCtCQUErQjtRQUMvQixJQUFJLENBQUMsUUFBUSxDQUFDLE9BQU8sQ0FBQyxJQUFJLEVBQUUsSUFBSSxDQUFDLENBQUM7UUFDbEMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxPQUFPLEdBQUcsRUFBRSxDQUFDO1FBRTNCLHlCQUF5QjtRQUN6QixJQUFJLENBQUMsUUFBUSxDQUFDLEtBQUssRUFBRSxDQUFDO1FBRXRCLDJDQUEyQztRQUMzQyxJQUFJLFVBQVUsSUFBSSxPQUFPLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxPQUFPLEVBQUUsQ0FBQyxLQUFLLFFBQVEsRUFBRTtZQUM3RCxJQUFJLENBQUMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxVQUFDLElBQU87Z0JBQ3hCLEtBQUksQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUM7WUFDekQsQ0FBQyxDQUFDLENBQUM7U0FDTjtRQUVELGNBQWM7UUFDZCxJQUFJLENBQUMsTUFBTSxDQUFDLEtBQUssRUFBRSxDQUFDO1FBRXBCLElBQUksQ0FBQyxRQUFRLENBQUMsU0FBUyxDQUFDLEVBQUUsS0FBSyxFQUFFLENBQUMsRUFBRSxFQUFFLEVBQUUsZ0JBQVMsQ0FBQyxLQUFLLEVBQUUsQ0FBQyxDQUFDO1FBRTNELHdDQUF3QztRQUN4QyxJQUFJLENBQUMsUUFBUSxDQUFDLFlBQVksRUFBRSxDQUFDO0lBQ2pDLENBQUM7SUFFRCx1QkFBRyxHQUFILFVBQUssR0FBTTtRQUNQLE9BQU8sSUFBSSxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLENBQUM7SUFDaEMsQ0FBQztJQUVELDJCQUFPLEdBQVAsVUFBUSxVQUFzRDtRQUMxRCxJQUFJLENBQUMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxVQUFVLENBQUMsQ0FBQztJQUNwQyxDQUFDO0lBRUQsMkJBQU8sR0FBUDtRQUNJLE9BQU8sSUFBSSxDQUFDLE1BQU0sQ0FBQyxPQUFPLEVBQUUsQ0FBQztJQUNqQyxDQUFDO0lBRUQsd0JBQUksR0FBSjtRQUNJLE9BQU8sSUFBSSxDQUFDLE1BQU0sQ0FBQyxJQUFJLEVBQUUsQ0FBQztJQUM5QixDQUFDO0lBRUQsMEJBQU0sR0FBTjtRQUNJLE9BQU8sSUFBSSxDQUFDLE1BQU0sQ0FBQyxNQUFNLEVBQUUsQ0FBQztJQUNoQyxDQUFDO0lBRUQsc0JBQUksMkJBQUk7YUFBUjtZQUNJLE9BQU8sSUFBSSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUM7UUFDNUIsQ0FBQzs7O09BQUE7SUFFUyw0QkFBUSxHQUFsQixVQUFtQixLQUFhLEVBQUUsR0FBVztRQUN6QyxJQUFJLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxLQUFLLEVBQUUsR0FBRyxDQUFDLENBQUM7SUFDbEMsQ0FBQztJQUVTLDRCQUFRLEdBQWxCLFVBQW1CLEtBQWE7UUFDNUIsT0FBTyxJQUFJLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxLQUFLLENBQUMsQ0FBQztJQUNwQyxDQUFDO0lBRVMsOEJBQVUsR0FBcEIsVUFBcUIsS0FBYTtRQUM5QixPQUFPLElBQUksQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUM7SUFDckQsQ0FBQztJQUVTLGlDQUFhLEdBQXZCLFVBQXdCLEtBQWE7UUFDakMsSUFBTSxHQUFHLEdBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsS0FBSyxDQUFDLENBQUM7UUFDckMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUM7UUFDeEIsSUFBSSxDQUFDLFFBQVEsQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLENBQUM7SUFDaEMsQ0FBQztJQUVELDBCQUFNLEdBQU47UUFDSSxJQUFNLEdBQUcsR0FBUSxFQUFFLENBQUM7UUFFcEIsSUFBSSxDQUFDLE9BQU8sQ0FBQyxVQUFDLEtBQUssRUFBRSxHQUFHO1lBQ3BCLEdBQUcsQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUMsUUFBUSxDQUFDLENBQUMsS0FBSyxVQUFVLENBQUM7Z0JBQ2hELENBQUMsQ0FBQyxLQUFLLENBQUMsUUFBUSxDQUFDLEVBQUU7Z0JBQ25CLENBQUMsQ0FBQyxLQUFLLENBQUM7UUFDaEIsQ0FBQyxDQUFDLENBQUM7UUFFSCxPQUFPLEdBQUcsQ0FBQztJQUNmLENBQUM7SUFFRCxFQUFFO0lBQ0YscUJBQXFCO0lBQ3JCLEVBQUU7SUFDRix5QkFBSyxHQUFMLFVBQU0sVUFBb0I7UUFDdEIsSUFBSSxNQUFpQixDQUFDO1FBRXRCLElBQUksVUFBVSxFQUFFO1lBQ1osY0FBYztZQUNkLE1BQU0sR0FBRyxNQUFNLENBQUMsTUFBTSxDQUFDLElBQUksU0FBUyxFQUFFLEVBQUUsSUFBSSxDQUFDLENBQUM7U0FFakQ7YUFBTTtZQUNILGNBQWM7WUFDZCxJQUFNLFFBQU0sR0FBRyxJQUFJLFNBQVMsRUFBRSxDQUFDO1lBQy9CLElBQUksQ0FBQyxPQUFPLENBQUMsVUFBQyxLQUFLLEVBQUUsR0FBRztnQkFDcEIsSUFBSSxLQUFLLENBQUMsVUFBVSxDQUFDLEVBQUU7b0JBQ25CLFFBQU0sQ0FBQyxHQUFHLENBQUMsR0FBRyxFQUFFLEtBQUssQ0FBQyxPQUFPLENBQUMsRUFBRSxDQUFDLENBQUM7aUJBQ3JDO3FCQUFNO29CQUNILFFBQU0sQ0FBQyxHQUFHLENBQUMsR0FBRyxFQUFFLEtBQUssQ0FBQyxDQUFDO2lCQUMxQjtZQUNMLENBQUMsQ0FBQyxDQUFBO1NBQ0w7UUFFRCxPQUFPLE1BQU0sQ0FBQztJQUNsQixDQUFDO0lBRUQsOEJBQVUsR0FBVjtRQUNJLGVBQU0sQ0FBQyxTQUFTLENBQUMsVUFBVSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUM1QyxDQUFDO0lBQ0wsZ0JBQUM7QUFBRCxDQUFDLEFBMU1ELElBME1DO0FBMU1ZLDhCQUFTIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQ2hhbmdlVHJlZSB9IGZyb20gXCIuLi9jaGFuZ2VzL0NoYW5nZVRyZWVcIjtcbmltcG9ydCB7IE9QRVJBVElPTiB9IGZyb20gXCIuLi9zcGVjXCI7XG5pbXBvcnQgeyBTY2hlbWFEZWNvZGVyQ2FsbGJhY2tzLCBTY2hlbWEgfSBmcm9tIFwiLi4vU2NoZW1hXCI7XG5cbnR5cGUgSyA9IHN0cmluZzsgLy8gVE9ETzogYWxsb3cgdG8gc3BlY2lmeSBLIGdlbmVyaWMgb24gTWFwU2NoZW1hLlxuXG5leHBvcnQgZnVuY3Rpb24gZ2V0TWFwUHJveHkodmFsdWU6IE1hcFNjaGVtYSkge1xuICAgIHZhbHVlWyckcHJveHknXSA9IHRydWU7XG5cbiAgICB2YWx1ZSA9IG5ldyBQcm94eSh2YWx1ZSwge1xuICAgICAgICBnZXQ6IChvYmosIHByb3ApID0+IHtcbiAgICAgICAgICAgIGlmIChcbiAgICAgICAgICAgICAgICB0eXBlb2YgKHByb3ApICE9PSBcInN5bWJvbFwiICYmIC8vIGFjY2Vzc2luZyBwcm9wZXJ0aWVzXG4gICAgICAgICAgICAgICAgdHlwZW9mIChvYmpbcHJvcF0pID09PSBcInVuZGVmaW5lZFwiXG4gICAgICAgICAgICApIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gb2JqLmdldChwcm9wIGFzIHN0cmluZyk7XG5cbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIG9ialtwcm9wXTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSxcblxuICAgICAgICBzZXQ6IChvYmosIHByb3AsIHNldFZhbHVlKSA9PiB7XG4gICAgICAgICAgICBpZiAoXG4gICAgICAgICAgICAgICAgdHlwZW9mIChwcm9wKSAhPT0gXCJzeW1ib2xcIiAmJlxuICAgICAgICAgICAgICAgIChcbiAgICAgICAgICAgICAgICAgICAgKHByb3AgYXMgc3RyaW5nKS5pbmRleE9mKFwiJFwiKSA9PT0gLTEgJiZcbiAgICAgICAgICAgICAgICAgICAgcHJvcCAhPT0gXCJvbkFkZFwiICYmXG4gICAgICAgICAgICAgICAgICAgIHByb3AgIT09IFwib25SZW1vdmVcIiAmJlxuICAgICAgICAgICAgICAgICAgICBwcm9wICE9PSBcIm9uQ2hhbmdlXCJcbiAgICAgICAgICAgICAgICApXG4gICAgICAgICAgICApIHtcbiAgICAgICAgICAgICAgICBvYmouc2V0KHByb3AgYXMgc3RyaW5nLCBzZXRWYWx1ZSk7XG5cbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgb2JqW3Byb3BdID0gc2V0VmFsdWU7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgfSxcblxuICAgICAgICBkZWxldGVQcm9wZXJ0eTogKG9iaiwgcHJvcCkgPT4ge1xuICAgICAgICAgICAgb2JqLmRlbGV0ZShwcm9wIGFzIHN0cmluZyk7XG4gICAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgfSxcbiAgICB9KTtcblxuICAgIHJldHVybiB2YWx1ZTtcbn1cblxuZXhwb3J0IGNsYXNzIE1hcFNjaGVtYTxWPWFueT4gaW1wbGVtZW50cyBNYXA8c3RyaW5nLCBWPiwgU2NoZW1hRGVjb2RlckNhbGxiYWNrcyB7XG4gICAgcHJvdGVjdGVkICRjaGFuZ2VzOiBDaGFuZ2VUcmVlID0gbmV3IENoYW5nZVRyZWUodGhpcyk7XG5cbiAgICBwcm90ZWN0ZWQgJGl0ZW1zOiBNYXA8c3RyaW5nLCBWPiA9IG5ldyBNYXA8c3RyaW5nLCBWPigpO1xuICAgIHByb3RlY3RlZCAkaW5kZXhlczogTWFwPG51bWJlciwgc3RyaW5nPiA9IG5ldyBNYXA8bnVtYmVyLCBzdHJpbmc+KCk7XG5cbiAgICBwcm90ZWN0ZWQgJHJlZklkOiBudW1iZXIgPSAwO1xuXG4gICAgLy9cbiAgICAvLyBEZWNvZGluZyBjYWxsYmFja3NcbiAgICAvL1xuICAgIHB1YmxpYyBvbkFkZD86IChpdGVtOiBWLCBrZXk6IHN0cmluZykgPT4gdm9pZDtcbiAgICBwdWJsaWMgb25SZW1vdmU/OiAoaXRlbTogViwga2V5OiBzdHJpbmcpID0+IHZvaWQ7XG4gICAgcHVibGljIG9uQ2hhbmdlPzogKGl0ZW06IFYsIGtleTogc3RyaW5nKSA9PiB2b2lkO1xuXG4gICAgc3RhdGljIGlzKHR5cGU6IGFueSkge1xuICAgICAgICByZXR1cm4gdHlwZVsnbWFwJ10gIT09IHVuZGVmaW5lZDtcbiAgICB9XG5cbiAgICBjb25zdHJ1Y3RvciAoaW5pdGlhbFZhbHVlcz86IE1hcDxzdHJpbmcsIFY+IHwgYW55KSB7XG4gICAgICAgIGlmIChpbml0aWFsVmFsdWVzKSB7XG4gICAgICAgICAgICBpZiAoaW5pdGlhbFZhbHVlcyBpbnN0YW5jZW9mIE1hcCkge1xuICAgICAgICAgICAgICAgIGluaXRpYWxWYWx1ZXMuZm9yRWFjaCgodiwgaykgPT4gdGhpcy5zZXQoaywgdikpO1xuXG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIGZvciAoY29uc3QgayBpbiBpbml0aWFsVmFsdWVzKSB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuc2V0KGssIGluaXRpYWxWYWx1ZXNba10pO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH1cblxuICAgIC8qKiBJdGVyYXRvciAqL1xuICAgIFtTeW1ib2wuaXRlcmF0b3JdKCk6IEl0ZXJhYmxlSXRlcmF0b3I8W0ssIFZdPiB7IHJldHVybiB0aGlzLiRpdGVtc1tTeW1ib2wuaXRlcmF0b3JdKCk7IH1cbiAgICBnZXQgW1N5bWJvbC50b1N0cmluZ1RhZ10oKSB7IHJldHVybiB0aGlzLiRpdGVtc1tTeW1ib2wudG9TdHJpbmdUYWddIH1cblxuICAgIHNldChrZXk6IEssIHZhbHVlOiBWKSB7XG4gICAgICAgIC8vIGdldCBcImluZGV4XCIgZm9yIHRoaXMgdmFsdWUuXG4gICAgICAgIGNvbnN0IGhhc0luZGV4ID0gdHlwZW9mKHRoaXMuJGNoYW5nZXMuaW5kZXhlc1trZXldKSAhPT0gXCJ1bmRlZmluZWRcIjtcbiAgICAgICAgY29uc3QgaW5kZXggPSAoaGFzSW5kZXgpXG4gICAgICAgICAgICA/IHRoaXMuJGNoYW5nZXMuaW5kZXhlc1trZXldXG4gICAgICAgICAgICA6IHRoaXMuJHJlZklkKys7XG5cbiAgICAgICAgbGV0IG9wZXJhdGlvbjogT1BFUkFUSU9OID0gKGhhc0luZGV4KVxuICAgICAgICAgICAgPyBPUEVSQVRJT04uUkVQTEFDRVxuICAgICAgICAgICAgOiBPUEVSQVRJT04uQUREO1xuXG4gICAgICAgIGNvbnN0IGlzUmVmID0gKHZhbHVlWyckY2hhbmdlcyddKSAhPT0gdW5kZWZpbmVkO1xuICAgICAgICBpZiAoaXNSZWYpIHtcbiAgICAgICAgICAgICh2YWx1ZVsnJGNoYW5nZXMnXSBhcyBDaGFuZ2VUcmVlKS5zZXRQYXJlbnQoXG4gICAgICAgICAgICAgICAgdGhpcyxcbiAgICAgICAgICAgICAgICB0aGlzLiRjaGFuZ2VzLnJvb3QsXG4gICAgICAgICAgICAgICAgaW5kZXhcbiAgICAgICAgICAgICk7XG4gICAgICAgIH1cblxuICAgICAgICAvL1xuICAgICAgICAvLyAoZW5jb2RpbmcpXG4gICAgICAgIC8vIHNldCBhIHVuaXF1ZSBpZCB0byByZWxhdGUgZGlyZWN0bHkgd2l0aCB0aGlzIGtleS92YWx1ZS5cbiAgICAgICAgLy9cbiAgICAgICAgaWYgKCFoYXNJbmRleCkge1xuICAgICAgICAgICAgdGhpcy4kY2hhbmdlcy5pbmRleGVzW2tleV0gPSBpbmRleDtcbiAgICAgICAgICAgIHRoaXMuJGluZGV4ZXMuc2V0KGluZGV4LCBrZXkpO1xuXG4gICAgICAgIH0gZWxzZSBpZiAoXG4gICAgICAgICAgICBpc1JlZiAmJiAvLyBpZiBpcyBzY2hlbWEsIGZvcmNlIEFERCBvcGVyYXRpb24gaWYgdmFsdWUgZGlmZmVyIGZyb20gcHJldmlvdXMgb25lLlxuICAgICAgICAgICAgdGhpcy4kaXRlbXMuZ2V0KGtleSkgIT09IHZhbHVlXG4gICAgICAgICkge1xuICAgICAgICAgICAgb3BlcmF0aW9uID0gT1BFUkFUSU9OLkFERDtcbiAgICAgICAgfVxuXG4gICAgICAgIHRoaXMuJGl0ZW1zLnNldChrZXksIHZhbHVlKTtcblxuICAgICAgICB0aGlzLiRjaGFuZ2VzLmNoYW5nZShrZXksIG9wZXJhdGlvbik7XG5cbiAgICAgICAgcmV0dXJuIHRoaXM7XG4gICAgfVxuXG4gICAgZ2V0KGtleTogSykge1xuICAgICAgICByZXR1cm4gdGhpcy4kaXRlbXMuZ2V0KGtleSk7XG4gICAgfVxuXG4gICAgZGVsZXRlKGtleTogSykge1xuICAgICAgICAvL1xuICAgICAgICAvLyBUT0RPOiBhZGQgYSBcInB1cmdlXCIgbWV0aG9kIGFmdGVyIC5lbmNvZGUoKSBydW5zLCB0byBjbGVhbnVwIHJlbW92ZWQgYCRpbmRleGVzYFxuICAgICAgICAvL1xuICAgICAgICAvLyBXZSBkb24ndCByZW1vdmUgJGluZGV4ZXMgdG8gYWxsb3cgc2V0dGluZyB0aGUgc2FtZSBrZXkgaW4gdGhlIHNhbWUgcGF0Y2hcbiAgICAgICAgLy8gKFNlZSBcInNob3VsZCBhbGxvdyB0byByZW1vdmUgYW5kIHNldCBhbiBpdGVtIGluIHRoZSBzYW1lIHBsYWNlXCIgdGVzdClcbiAgICAgICAgLy9cbiAgICAgICAgLy8gLy8gY29uc3QgaW5kZXggPSB0aGlzLiRjaGFuZ2VzLmluZGV4ZXNba2V5XTtcbiAgICAgICAgLy8gLy8gdGhpcy4kaW5kZXhlcy5kZWxldGUoaW5kZXgpO1xuXG4gICAgICAgIHRoaXMuJGNoYW5nZXMuZGVsZXRlKGtleSk7XG4gICAgICAgIHJldHVybiB0aGlzLiRpdGVtcy5kZWxldGUoa2V5KTtcbiAgICB9XG5cbiAgICBjbGVhcihpc0RlY29kaW5nPzogYm9vbGVhbikge1xuICAgICAgICAvLyBkaXNjYXJkIHByZXZpb3VzIG9wZXJhdGlvbnMuXG4gICAgICAgIHRoaXMuJGNoYW5nZXMuZGlzY2FyZCh0cnVlLCB0cnVlKTtcbiAgICAgICAgdGhpcy4kY2hhbmdlcy5pbmRleGVzID0ge307XG5cbiAgICAgICAgLy8gY2xlYXIgcHJldmlvdXMgaW5kZXhlc1xuICAgICAgICB0aGlzLiRpbmRleGVzLmNsZWFyKCk7XG5cbiAgICAgICAgLy8gZmxhZyBjaGlsZCBpdGVtcyBmb3IgZ2FyYmFnZSBjb2xsZWN0aW9uLlxuICAgICAgICBpZiAoaXNEZWNvZGluZyAmJiB0eXBlb2YgKHRoaXMuJGNoYW5nZXMuZ2V0VHlwZSgpKSAhPT0gXCJzdHJpbmdcIikge1xuICAgICAgICAgICAgdGhpcy4kaXRlbXMuZm9yRWFjaCgoaXRlbTogVikgPT4ge1xuICAgICAgICAgICAgICAgIHRoaXMuJGNoYW5nZXMucm9vdC5yZW1vdmVSZWYoaXRlbVsnJGNoYW5nZXMnXS5yZWZJZCk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIGNsZWFyIGl0ZW1zXG4gICAgICAgIHRoaXMuJGl0ZW1zLmNsZWFyKCk7XG5cbiAgICAgICAgdGhpcy4kY2hhbmdlcy5vcGVyYXRpb24oeyBpbmRleDogMCwgb3A6IE9QRVJBVElPTi5DTEVBUiB9KTtcblxuICAgICAgICAvLyB0b3VjaCBhbGwgc3RydWN0dXJlcyB1bnRpbCByZWFjaCByb290XG4gICAgICAgIHRoaXMuJGNoYW5nZXMudG91Y2hQYXJlbnRzKCk7XG4gICAgfVxuXG4gICAgaGFzIChrZXk6IEspIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuJGl0ZW1zLmhhcyhrZXkpO1xuICAgIH1cblxuICAgIGZvckVhY2goY2FsbGJhY2tmbjogKHZhbHVlOiBWLCBrZXk6IEssIG1hcDogTWFwPEssIFY+KSA9PiB2b2lkKSB7XG4gICAgICAgIHRoaXMuJGl0ZW1zLmZvckVhY2goY2FsbGJhY2tmbik7XG4gICAgfVxuXG4gICAgZW50cmllcyAoKSB7XG4gICAgICAgIHJldHVybiB0aGlzLiRpdGVtcy5lbnRyaWVzKCk7XG4gICAgfVxuXG4gICAga2V5cyAoKSB7XG4gICAgICAgIHJldHVybiB0aGlzLiRpdGVtcy5rZXlzKCk7XG4gICAgfVxuXG4gICAgdmFsdWVzKCkge1xuICAgICAgICByZXR1cm4gdGhpcy4kaXRlbXMudmFsdWVzKCk7XG4gICAgfVxuXG4gICAgZ2V0IHNpemUgKCkge1xuICAgICAgICByZXR1cm4gdGhpcy4kaXRlbXMuc2l6ZTtcbiAgICB9XG5cbiAgICBwcm90ZWN0ZWQgc2V0SW5kZXgoaW5kZXg6IG51bWJlciwga2V5OiBzdHJpbmcpIHtcbiAgICAgICAgdGhpcy4kaW5kZXhlcy5zZXQoaW5kZXgsIGtleSk7XG4gICAgfVxuXG4gICAgcHJvdGVjdGVkIGdldEluZGV4KGluZGV4OiBudW1iZXIpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuJGluZGV4ZXMuZ2V0KGluZGV4KTtcbiAgICB9XG5cbiAgICBwcm90ZWN0ZWQgZ2V0QnlJbmRleChpbmRleDogbnVtYmVyKSB7XG4gICAgICAgIHJldHVybiB0aGlzLiRpdGVtcy5nZXQodGhpcy4kaW5kZXhlcy5nZXQoaW5kZXgpKTtcbiAgICB9XG5cbiAgICBwcm90ZWN0ZWQgZGVsZXRlQnlJbmRleChpbmRleDogbnVtYmVyKSB7XG4gICAgICAgIGNvbnN0IGtleSA9IHRoaXMuJGluZGV4ZXMuZ2V0KGluZGV4KTtcbiAgICAgICAgdGhpcy4kaXRlbXMuZGVsZXRlKGtleSk7XG4gICAgICAgIHRoaXMuJGluZGV4ZXMuZGVsZXRlKGluZGV4KTtcbiAgICB9XG5cbiAgICB0b0pTT04oKSB7XG4gICAgICAgIGNvbnN0IG1hcDogYW55ID0ge307XG5cbiAgICAgICAgdGhpcy5mb3JFYWNoKCh2YWx1ZSwga2V5KSA9PiB7XG4gICAgICAgICAgICBtYXBba2V5XSA9ICh0eXBlb2YgKHZhbHVlWyd0b0pTT04nXSkgPT09IFwiZnVuY3Rpb25cIilcbiAgICAgICAgICAgICAgICA/IHZhbHVlWyd0b0pTT04nXSgpXG4gICAgICAgICAgICAgICAgOiB2YWx1ZTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgcmV0dXJuIG1hcDtcbiAgICB9XG5cbiAgICAvL1xuICAgIC8vIERlY29kaW5nIHV0aWxpdGllc1xuICAgIC8vXG4gICAgY2xvbmUoaXNEZWNvZGluZz86IGJvb2xlYW4pOiBNYXBTY2hlbWE8Vj4ge1xuICAgICAgICBsZXQgY2xvbmVkOiBNYXBTY2hlbWE7XG5cbiAgICAgICAgaWYgKGlzRGVjb2RpbmcpIHtcbiAgICAgICAgICAgIC8vIGNsaWVudC1zaWRlXG4gICAgICAgICAgICBjbG9uZWQgPSBPYmplY3QuYXNzaWduKG5ldyBNYXBTY2hlbWEoKSwgdGhpcyk7XG5cbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIC8vIHNlcnZlci1zaWRlXG4gICAgICAgICAgICBjb25zdCBjbG9uZWQgPSBuZXcgTWFwU2NoZW1hKCk7XG4gICAgICAgICAgICB0aGlzLmZvckVhY2goKHZhbHVlLCBrZXkpID0+IHtcbiAgICAgICAgICAgICAgICBpZiAodmFsdWVbJyRjaGFuZ2VzJ10pIHtcbiAgICAgICAgICAgICAgICAgICAgY2xvbmVkLnNldChrZXksIHZhbHVlWydjbG9uZSddKCkpO1xuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIGNsb25lZC5zZXQoa2V5LCB2YWx1ZSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSlcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBjbG9uZWQ7XG4gICAgfVxuXG4gICAgdHJpZ2dlckFsbCAoKTogdm9pZCB7XG4gICAgICAgIFNjaGVtYS5wcm90b3R5cGUudHJpZ2dlckFsbC5hcHBseSh0aGlzKTtcbiAgICB9XG59Il19