"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    Object.defineProperty(o, k2, { enumerable: true, get: function() { return m[k]; } });
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.Room = void 0;
var msgpack = __importStar(require("./msgpack"));
var strong_events_1 = require("strong-events");
var nanoevents_1 = require("nanoevents");
var Connection_1 = require("./Connection");
var Serializer_1 = require("./serializer/Serializer");
var Protocol_1 = require("./Protocol");
var encode = __importStar(require("@colyseus/schema/lib/encoding/encode"));
var decode = __importStar(require("@colyseus/schema/lib/encoding/decode"));
var Room = /** @class */ (function () {
    function Room(name, rootSchema) {
        var _this = this;
        // Public signals
        this.onStateChange = strong_events_1.createSignal();
        this.onError = strong_events_1.createSignal();
        this.onLeave = strong_events_1.createSignal();
        this.onJoin = strong_events_1.createSignal();
        this.hasJoined = false;
        this.onMessageHandlers = nanoevents_1.createNanoEvents();
        this.id = null;
        this.name = name;
        if (rootSchema) {
            this.serializer = new (Serializer_1.getSerializer("schema"));
            this.rootSchema = rootSchema;
            this.serializer.state = new rootSchema();
        }
        this.onError(function (code, message) { return console.warn("colyseus.js - onError => (" + code + ") " + message); });
        this.onLeave(function () { return _this.removeAllListeners(); });
    }
    Room.prototype.connect = function (endpoint) {
        var _this = this;
        this.connection = new Connection_1.Connection(endpoint, false);
        this.connection.reconnectEnabled = false;
        this.connection.onmessage = this.onMessageCallback.bind(this);
        this.connection.onclose = function (e) {
            if (!_this.hasJoined) {
                console.warn("Room connection was closed unexpectedly (" + e.code + "): " + e.reason);
                _this.onError.invoke(e.code, e.reason);
                return;
            }
            _this.onLeave.invoke(e.code);
        };
        this.connection.onerror = function (e) {
            console.warn("Room, onError (" + e.code + "): " + e.reason);
            _this.onError.invoke(e.code, e.reason);
        };
        this.connection.open();
    };
    Room.prototype.leave = function (consented) {
        if (consented === void 0) { consented = true; }
        if (this.connection) {
            if (consented) {
                this.connection.send([Protocol_1.Protocol.LEAVE_ROOM]);
            }
            else {
                this.connection.close();
            }
        }
        else {
            this.onLeave.invoke(4000); // "consented" code
        }
    };
    Room.prototype.onMessage = function (type, callback) {
        return this.onMessageHandlers.on(this.getMessageHandlerKey(type), callback);
    };
    Room.prototype.send = function (type, message) {
        var initialBytes = [Protocol_1.Protocol.ROOM_DATA];
        if (typeof (type) === "string") {
            encode.string(initialBytes, type);
        }
        else {
            encode.number(initialBytes, type);
        }
        var arr;
        if (message !== undefined) {
            var encoded = msgpack.encode(message);
            arr = new Uint8Array(initialBytes.length + encoded.byteLength);
            arr.set(new Uint8Array(initialBytes), 0);
            arr.set(new Uint8Array(encoded), initialBytes.length);
        }
        else {
            arr = new Uint8Array(initialBytes);
        }
        this.connection.send(arr.buffer);
    };
    Object.defineProperty(Room.prototype, "state", {
        get: function () {
            return this.serializer.getState();
        },
        enumerable: false,
        configurable: true
    });
    // TODO: deprecate / move somewhere else
    // this method is useful only for FossilDeltaSerializer
    Room.prototype.listen = function (segments, callback, immediate) {
        if (this.serializerId === "schema") {
            console.warn("'" + this.serializerId + "' serializer doesn't support .listen() method here.");
            return;
        }
        else if (!this.serializerId) {
            console.warn("room.Listen() should be called after room.onJoin has been called (DEPRECATION WARNING)");
        }
        return this.serializer.api.listen(segments, callback, immediate);
    };
    // TODO: deprecate / move somewhere else
    // this method is useful only for FossilDeltaSerializer
    Room.prototype.removeListener = function (listener) {
        return this.serializer.api.removeListener(listener);
    };
    Room.prototype.removeAllListeners = function () {
        if (this.serializer) {
            this.serializer.teardown();
        }
        this.onJoin.clear();
        this.onStateChange.clear();
        this.onError.clear();
        this.onLeave.clear();
        this.onMessageHandlers.events = {};
    };
    Room.prototype.onMessageCallback = function (event) {
        var bytes = Array.from(new Uint8Array(event.data));
        var code = bytes[0];
        if (code === Protocol_1.Protocol.JOIN_ROOM) {
            var offset = 1;
            this.serializerId = Protocol_1.utf8Read(bytes, offset);
            offset += Protocol_1.utf8Length(this.serializerId);
            // Instantiate serializer if not locally available.
            if (!this.serializer) {
                var serializer = Serializer_1.getSerializer(this.serializerId);
                this.serializer = new serializer();
            }
            if (bytes.length > offset && this.serializer.handshake) {
                this.serializer.handshake(bytes, { offset: offset });
            }
            this.hasJoined = true;
            this.onJoin.invoke();
            // acknowledge successfull JOIN_ROOM
            this.connection.send([Protocol_1.Protocol.JOIN_ROOM]);
        }
        else if (code === Protocol_1.Protocol.ERROR) {
            var it_1 = { offset: 1 };
            var code_1 = decode.number(bytes, it_1);
            var message = decode.string(bytes, it_1);
            this.onError.invoke(code_1, message);
        }
        else if (code === Protocol_1.Protocol.LEAVE_ROOM) {
            this.leave();
        }
        else if (code === Protocol_1.Protocol.ROOM_DATA_SCHEMA) {
            var it_2 = { offset: 1 };
            var context_1 = this.serializer.getState().constructor._context;
            var type = context_1.get(decode.number(bytes, it_2));
            var message = new type();
            message.decode(bytes, it_2);
            this.dispatchMessage(type, message);
        }
        else if (code === Protocol_1.Protocol.ROOM_STATE) {
            bytes.shift(); // drop `code` byte
            this.setState(bytes);
        }
        else if (code === Protocol_1.Protocol.ROOM_STATE_PATCH) {
            bytes.shift(); // drop `code` byte
            this.patch(bytes);
        }
        else if (code === Protocol_1.Protocol.ROOM_DATA) {
            var it_3 = { offset: 1 };
            var type = (decode.stringCheck(bytes, it_3))
                ? decode.string(bytes, it_3)
                : decode.number(bytes, it_3);
            var message = (bytes.length > it_3.offset)
                ? msgpack.decode(event.data, it_3.offset)
                : undefined;
            this.dispatchMessage(type, message);
        }
    };
    Room.prototype.setState = function (encodedState) {
        this.serializer.setState(encodedState);
        this.onStateChange.invoke(this.serializer.getState());
    };
    Room.prototype.patch = function (binaryPatch) {
        this.serializer.patch(binaryPatch);
        this.onStateChange.invoke(this.serializer.getState());
    };
    Room.prototype.dispatchMessage = function (type, message) {
        var messageType = this.getMessageHandlerKey(type);
        if (this.onMessageHandlers.events[messageType]) {
            this.onMessageHandlers.emit(messageType, message);
        }
        else if (this.onMessageHandlers.events['*']) {
            this.onMessageHandlers.emit('*', type, message);
        }
        else {
            console.warn("onMessage not registered for type '" + type + "'.");
        }
    };
    Room.prototype.getMessageHandlerKey = function (type) {
        switch (typeof (type)) {
            // typeof Schema
            case "function": return "$" + type._typeid;
            // string
            case "string": return type;
            // number
            case "number": return "i" + type;
            default: throw new Error("invalid message type.");
        }
    };
    return Room;
}());
exports.Room = Room;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiUm9vbS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy9Sb29tLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFBQSxpREFBcUM7QUFFckMsK0NBQTZDO0FBQzdDLHlDQUE4QztBQUU5QywyQ0FBMEM7QUFDMUMsc0RBQW9FO0FBQ3BFLHVDQUE0RDtBQVE1RCwyRUFBK0Q7QUFDL0QsMkVBQStEO0FBUy9EO0lBdUJJLGNBQVksSUFBWSxFQUFFLFVBQXFDO1FBQS9ELGlCQVlDO1FBNUJELGlCQUFpQjtRQUNWLGtCQUFhLEdBQUcsNEJBQVksRUFBMEIsQ0FBQztRQUN2RCxZQUFPLEdBQUcsNEJBQVksRUFBNEMsQ0FBQztRQUNuRSxZQUFPLEdBQUcsNEJBQVksRUFBMEIsQ0FBQztRQUM5QyxXQUFNLEdBQUcsNEJBQVksRUFBRSxDQUFDO1FBS3hCLGNBQVMsR0FBWSxLQUFLLENBQUM7UUFLM0Isc0JBQWlCLEdBQUcsNkJBQWdCLEVBQUUsQ0FBQztRQUc3QyxJQUFJLENBQUMsRUFBRSxHQUFHLElBQUksQ0FBQztRQUNmLElBQUksQ0FBQyxJQUFJLEdBQUcsSUFBSSxDQUFDO1FBRWpCLElBQUksVUFBVSxFQUFFO1lBQ1osSUFBSSxDQUFDLFVBQVUsR0FBRyxJQUFJLENBQUMsMEJBQWEsQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDO1lBQ2hELElBQUksQ0FBQyxVQUFVLEdBQUcsVUFBVSxDQUFDO1lBQzVCLElBQUksQ0FBQyxVQUErQixDQUFDLEtBQUssR0FBRyxJQUFJLFVBQVUsRUFBRSxDQUFDO1NBQ2xFO1FBRUQsSUFBSSxDQUFDLE9BQU8sQ0FBQyxVQUFDLElBQUksRUFBRSxPQUFPLElBQUssT0FBQSxPQUFPLENBQUMsSUFBSSxDQUFDLCtCQUE2QixJQUFJLFVBQUssT0FBUyxDQUFDLEVBQTdELENBQTZELENBQUMsQ0FBQztRQUMvRixJQUFJLENBQUMsT0FBTyxDQUFDLGNBQU0sT0FBQSxLQUFJLENBQUMs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LEtBQUssUUFBUSxDQUFDLENBQUMsT0FBTyxJQUFJLENBQUM7WUFFM0IsU0FBUztZQUNULEtBQUssUUFBUSxDQUFDLENBQUMsT0FBTyxNQUFJLElBQU0sQ0FBQztZQUVqQyxPQUFPLENBQUMsQ0FBQyxNQUFNLElBQUksS0FBSyxDQUFDLHVCQUF1QixDQUFDLENBQUM7U0FDckQ7SUFDTCxDQUFDO0lBRUwsV0FBQztBQUFELENBQUMsQUFuUUQsSUFtUUM7QUFuUVksb0JBQUkiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyBtc2dwYWNrIGZyb20gJy4vbXNncGFjayc7XG5cbmltcG9ydCB7IGNyZWF0ZVNpZ25hbCB9IGZyb20gJ3N0cm9uZy1ldmVudHMnO1xuaW1wb3J0IHsgY3JlYXRlTmFub0V2ZW50cyB9IGZyb20gJ25hbm9ldmVudHMnO1xuXG5pbXBvcnQgeyBDb25uZWN0aW9uIH0gZnJvbSAnLi9Db25uZWN0aW9uJztcbmltcG9ydCB7IFNlcmlhbGl6ZXIsIGdldFNlcmlhbGl6ZXIgfSBmcm9tICcuL3NlcmlhbGl6ZXIvU2VyaWFsaXplcic7XG5pbXBvcnQgeyBQcm90b2NvbCwgdXRmOFJlYWQsIHV0ZjhMZW5ndGggfSBmcm9tICcuL1Byb3RvY29sJztcblxuaW1wb3J0IHsgRm9zc2lsRGVsdGFTZXJpYWxpemVyIH0gZnJvbSAnLi9zZXJpYWxpemVyL0Zvc3NpbERlbHRhU2VyaWFsaXplcic7XG5pbXBvcnQgeyBMaXN0ZW5lciB9IGZyb20gJ0BnYW1lc3RkaW8vc3RhdGUtbGlzdGVuZXInO1xuaW1wb3J0IHsgU2NoZW1hU2VyaWFsaXplciB9IGZyb20gJy4nO1xuaW1wb3J0IHsgU2NoZW1hQ29uc3RydWN0b3IgfSBmcm9tICcuL3NlcmlhbGl6ZXIvU2NoZW1hU2VyaWFsaXplcic7XG5pbXBvcnQgeyBDb250ZXh0LCBTY2hlbWEgfSBmcm9tICdAY29seXNldXMvc2NoZW1hJztcblxuaW1wb3J0ICogYXMgZW5jb2RlIGZyb20gJ0Bjb2x5c2V1cy9zY2hlbWEvbGliL2VuY29kaW5nL2VuY29kZSc7XG5pbXBvcnQgKiBhcyBkZWNvZGUgZnJvbSAnQGNvbHlzZXVzL3NjaGVtYS9saWIvZW5jb2RpbmcvZGVjb2RlJztcblxuZXhwb3J0IGludGVyZmFjZSBSb29tQXZhaWxhYmxlPE1ldGFkYXRhID0gYW55PiB7XG4gICAgcm9vbUlkOiBzdHJpbmc7XG4gICAgY2xpZW50czogbnVtYmVyO1xuICAgIG1heENsaWVudHM6IG51bWJlcjtcbiAgICBtZXRhZGF0YT86IE1ldGFkYXRhO1xufVxuXG5leHBvcnQgY2xhc3MgUm9vbTxTdGF0ZT0gYW55PiB7XG4gICAgcHVibGljIGlkOiBzdHJpbmc7XG4gICAgcHVibGljIHNlc3Npb25JZDogc3RyaW5nO1xuXG4gICAgcHVibGljIG5hbWU6IHN0cmluZztcbiAgICBwdWJsaWMgY29ubmVjdGlvbjogQ29ubmVjdGlvbjtcblxuICAgIC8vIFB1YmxpYyBzaWduYWxzXG4gICAgcHVibGljIG9uU3RhdGVDaGFuZ2UgPSBjcmVhdGVTaWduYWw8KHN0YXRlOiBTdGF0ZSkgPT4gdm9pZD4oKTtcbiAgICBwdWJsaWMgb25FcnJvciA9IGNyZWF0ZVNpZ25hbDwoY29kZTogbnVtYmVyLCBtZXNzYWdlPzogc3RyaW5nKSA9PiB2b2lkPigpO1xuICAgIHB1YmxpYyBvbkxlYXZlID0gY3JlYXRlU2lnbmFsPChjb2RlOiBudW1iZXIpID0+IHZvaWQ+KCk7XG4gICAgcHJvdGVjdGVkIG9uSm9pbiA9IGNyZWF0ZVNpZ25hbCgpO1xuXG4gICAgcHVibGljIHNlcmlhbGl6ZXJJZDogc3RyaW5nO1xuICAgIHByb3RlY3RlZCBzZXJpYWxpemVyOiBTZXJpYWxpemVyPFN0YXRlPjtcblxuICAgIHByb3RlY3RlZCBoYXNKb2luZWQ6IGJvb2xlYW4gPSBmYWxzZTtcblxuICAgIC8vIFRPRE86IHJlbW92ZSBtZSBvbiAxLjAuMFxuICAgIHByb3RlY3RlZCByb290U2NoZW1hOiBTY2hlbWFDb25zdHJ1Y3RvcjxTdGF0ZT47XG5cbiAgICBwcm90ZWN0ZWQgb25NZXNzYWdlSGFuZGxlcnMgPSBjcmVhdGVOYW5vRXZlbnRzKCk7XG5cbiAgICBjb25zdHJ1Y3RvcihuYW1lOiBzdHJpbmcsIHJvb3RTY2hlbWE/OiBTY2hlbWFDb25zdHJ1Y3RvcjxTdGF0ZT4pIHtcbiAgICAgICAgdGhpcy5pZCA9IG51bGw7XG4gICAgICAgIHRoaXMubmFtZSA9IG5hbWU7XG5cbiAgICAgICAgaWYgKHJvb3RTY2hlbWEpIHtcbiAgICAgICAgICAgIHRoaXMuc2VyaWFsaXplciA9IG5ldyAoZ2V0U2VyaWFsaXplcihcInNjaGVtYVwiKSk7XG4gICAgICAgICAgICB0aGlzLnJvb3RTY2hlbWEgPSByb290U2NoZW1hO1xuICAgICAgICAgICAgKHRoaXMuc2VyaWFsaXplciBhcyBTY2hlbWFTZXJpYWxpemVyKS5zdGF0ZSA9IG5ldyByb290U2NoZW1hKCk7XG4gICAgICAgIH1cblxuICAgICAgICB0aGlzLm9uRXJyb3IoKGNvZGUsIG1lc3NhZ2UpID0+IGNvbnNvbGUud2FybihgY29seXNldXMuanMgLSBvbkVycm9yID0+ICgke2NvZGV9KSAke21lc3NhZ2V9YCkpO1xuICAgICAgICB0aGlzLm9uTGVhdmUoKCkgPT4gdGhpcy5yZW1vdmVBbGxMaXN0ZW5lcnMoKSk7XG4gICAgfVxuXG4gICAgcHVibGljIGNvbm5lY3QoZW5kcG9pbnQ6IHN0cmluZykge1xuICAgICAgICB0aGlzLmNvbm5lY3Rpb24gPSBuZXcgQ29ubmVjdGlvbihlbmRwb2ludCwgZmFsc2UpO1xuICAgICAgICB0aGlzLmNvbm5lY3Rpb24ucmVjb25uZWN0RW5hYmxlZCA9IGZhbHNlO1xuICAgICAgICB0aGlzLmNvbm5lY3Rpb24ub25tZXNzYWdlID0gdGhpcy5vbk1lc3NhZ2VDYWxsYmFjay5iaW5kKHRoaXMpO1xuICAgICAgICB0aGlzLmNvbm5lY3Rpb24ub25jbG9zZSA9IChlOiBDbG9zZUV2ZW50KSA9PiB7XG4gICAgICAgICAgICBpZiAoIXRoaXMuaGFzSm9pbmVkKSB7XG4gICAgICAgICAgICAgICAgY29uc29sZS53YXJuKGBSb29tIGNvbm5lY3Rpb24gd2FzIGNsb3NlZCB1bmV4cGVjdGVkbHkgKCR7ZS5jb2RlfSk6ICR7ZS5yZWFzb259YCk7XG4gICAgICAgICAgICAgICAgdGhpcy5vbkVycm9yLmludm9rZShlLmNvZGUsIGUucmVhc29uKTtcbiAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHRoaXMub25MZWF2ZS5pbnZva2UoZS5jb2RlKVxuICAgICAgICB9O1xuICAgICAgICB0aGlzLmNvbm5lY3Rpb24ub25lcnJvciA9IChlOiBDbG9zZUV2ZW50KSA9PiB7XG4gICAgICAgICAgICBjb25zb2xlLndhcm4oYFJvb20sIG9uRXJyb3IgKCR7ZS5jb2RlfSk6ICR7ZS5yZWFzb259YCk7XG4gICAgICAgICAgICB0aGlzLm9uRXJyb3IuaW52b2tlKGUuY29kZSwgZS5yZWFzb24pO1xuICAgICAgICB9O1xuICAgICAgICB0aGlzLmNvbm5lY3Rpb24ub3BlbigpO1xuICAgIH1cblxuICAgIHB1YmxpYyBsZWF2ZShjb25zZW50ZWQ6IGJvb2xlYW4gPSB0cnVlKTogdm9pZCB7XG4gICAgICAgIGlmICh0aGlzLmNvbm5lY3Rpb24pIHtcbiAgICAgICAgICAgIGlmIChjb25zZW50ZWQpIHtcbiAgICAgICAgICAgICAgICB0aGlzLmNvbm5lY3Rpb24uc2VuZChbUHJvdG9jb2wuTEVBVkVfUk9PTV0pO1xuXG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHRoaXMuY29ubmVjdGlvbi5jbG9zZSgpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdGhpcy5vbkxlYXZlLmludm9rZSg0MDAwKTsgLy8gXCJjb25zZW50ZWRcIiBjb2RlXG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwdWJsaWMgb25NZXNzYWdlPFQgPSBhbnk+KFxuICAgICAgICB0eXBlOiBcIipcIixcbiAgICAgICAgY2FsbGJhY2s6ICh0eXBlOiBzdHJpbmcgfCBudW1iZXIgfCBTY2hlbWEsIG1lc3NhZ2U6IFQpID0+IHZvaWRcbiAgICApXG4gICAgcHVibGljIG9uTWVzc2FnZTxUIGV4dGVuZHMgKHR5cGVvZiBTY2hlbWEgJiAobmV3ICguLi5hcmdzOiBhbnlbXSkgPT4gYW55KSk+KFxuICAgICAgICB0eXBlOiBULFxuICAgICAgICBjYWxsYmFjazogKG1lc3NhZ2U6IEluc3RhbmNlVHlwZTxUPikgPT4gdm9pZFxuICAgIClcbiAgICBwdWJsaWMgb25NZXNzYWdlPFQgPSBhbnk+KFxuICAgICAgICB0eXBlOiBzdHJpbmcgfCBudW1iZXIsXG4gICAgICAgIGNhbGxiYWNrOiAobWVzc2FnZTogVCkgPT4gdm9pZFxuICAgIClcbiAgICBwdWJsaWMgb25NZXNzYWdlKFxuICAgICAgICB0eXBlOiAnKicgfCBzdHJpbmcgfCBudW1iZXIgfCB0eXBlb2YgU2NoZW1hLFxuICAgICAgICBjYWxsYmFjazogKC4uLmFyZ3M6IGFueVtdKSA9PiB2b2lkXG4gICAgKSB7XG4gICAgICAgIHJldHVybiB0aGlzLm9uTWVzc2FnZUhhbmRsZXJzLm9uKHRoaXMuZ2V0TWVzc2FnZUhhbmRsZXJLZXkodHlwZSksIGNhbGxiYWNrKTtcbiAgICB9XG5cbiAgICBwdWJsaWMgc2VuZCh0eXBlOiBzdHJpbmcgfCBudW1iZXIsIG1lc3NhZ2U/OiBhbnkpOiB2b2lkIHtcbiAgICAgICAgY29uc3QgaW5pdGlhbEJ5dGVzOiBudW1iZXJbXSA9IFtQcm90b2NvbC5ST09NX0RBVEFdO1xuXG4gICAgICAgIGlmICh0eXBlb2YodHlwZSkgPT09IFwic3RyaW5nXCIpIHtcbiAgICAgICAgICAgIGVuY29kZS5zdHJpbmcoaW5pdGlhbEJ5dGVzLCB0eXBlKTtcblxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgZW5jb2RlLm51bWJlcihpbml0aWFsQnl0ZXMsIHR5cGUpO1xuICAgICAgICB9XG5cbiAgICAgICAgbGV0IGFycjogVWludDhBcnJheTtcblxuICAgICAgICBpZiAobWVzc2FnZSAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICAgICAgICBjb25zdCBlbmNvZGVkID0gbXNncGFjay5lbmNvZGUobWVzc2FnZSk7XG4gICAgICAgICAgICBhcnIgPSBuZXcgVWludDhBcnJheShpbml0aWFsQnl0ZXMubGVuZ3RoICsgZW5jb2RlZC5ieXRlTGVuZ3RoKTtcbiAgICAgICAgICAgIGFyci5zZXQobmV3IFVpbnQ4QXJyYXkoaW5pdGlhbEJ5dGVzKSwgMCk7XG4gICAgICAgICAgICBhcnIuc2V0KG5ldyBVaW50OEFycmF5KGVuY29kZWQpLCBpbml0aWFsQnl0ZXMubGVuZ3RoKTtcblxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgYXJyID0gbmV3IFVpbnQ4QXJyYXkoaW5pdGlhbEJ5dGVzKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHRoaXMuY29ubmVjdGlvbi5zZW5kKGFyci5idWZmZXIpO1xuICAgIH1cblxuICAgIHB1YmxpYyBnZXQgc3RhdGUgKCk6IFN0YXRlIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuc2VyaWFsaXplci5nZXRTdGF0ZSgpO1xuICAgIH1cblxuICAgIC8vIFRPRE86IGRlcHJlY2F0ZSAvIG1vdmUgc29tZXdoZXJlIGVsc2VcbiAgICAvLyB0aGlzIG1ldGhvZCBpcyB1c2VmdWwgb25seSBmb3IgRm9zc2lsRGVsdGFTZXJpYWxpemVyXG4gICAgcHVibGljIGxpc3RlbihzZWdtZW50czogc3RyaW5nLCBjYWxsYmFjazogRnVuY3Rpb24sIGltbWVkaWF0ZT86IGJvb2xlYW4pIHtcbiAgICAgICAgaWYgKHRoaXMuc2VyaWFsaXplcklkID09PSBcInNjaGVtYVwiKSB7XG4gICAgICAgICAgICBjb25zb2xlLndhcm4oYCcke3RoaXMuc2VyaWFsaXplcklkfScgc2VyaWFsaXplciBkb2Vzbid0IHN1cHBvcnQgLmxpc3RlbigpIG1ldGhvZCBoZXJlLmApO1xuICAgICAgICAgICAgcmV0dXJuO1xuXG4gICAgICAgIH0gZWxzZSBpZiAoIXRoaXMuc2VyaWFsaXplcklkKSB7XG4gICAgICAgICAgICBjb25zb2xlLndhcm4oXCJyb29tLkxpc3RlbigpIHNob3VsZCBiZSBjYWxsZWQgYWZ0ZXIgcm9vbS5vbkpvaW4gaGFzIGJlZW4gY2FsbGVkIChERVBSRUNBVElPTiBXQVJOSU5HKVwiKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiAodGhpcy5zZXJpYWxpemVyIGFzIEZvc3NpbERlbHRhU2VyaWFsaXplcjxTdGF0ZT4pLmFwaS5saXN0ZW4oc2VnbWVudHMsIGNhbGxiYWNrLCBpbW1lZGlhdGUpO1xuICAgIH1cblxuICAgIC8vIFRPRE86IGRlcHJlY2F0ZSAvIG1vdmUgc29tZXdoZXJlIGVsc2VcbiAgICAvLyB0aGlzIG1ldGhvZCBpcyB1c2VmdWwgb25seSBmb3IgRm9zc2lsRGVsdGFTZXJpYWxpemVyXG4gICAgcHVibGljIHJlbW92ZUxpc3RlbmVyKGxpc3RlbmVyOiBMaXN0ZW5lcikge1xuICAgICAgICByZXR1cm4gKHRoaXMuc2VyaWFsaXplciBhcyBGb3NzaWxEZWx0YVNlcmlhbGl6ZXI8U3RhdGU+KS5hcGkucmVtb3ZlTGlzdGVuZXIobGlzdGVuZXIpXG4gICAgfVxuXG4gICAgcHVibGljIHJlbW92ZUFsbExpc3RlbmVycygpIHtcbiAgICAgICAgaWYgKHRoaXMuc2VyaWFsaXplcikge1xuICAgICAgICAgICAgdGhpcy5zZXJpYWxpemVyLnRlYXJkb3duKCk7XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5vbkpvaW4uY2xlYXIoKTtcbiAgICAgICAgdGhpcy5vblN0YXRlQ2hhbmdlLmNsZWFyKCk7XG4gICAgICAgIHRoaXMub25FcnJvci5jbGVhcigpO1xuICAgICAgICB0aGlzLm9uTGVhdmUuY2xlYXIoKTtcbiAgICAgICAgdGhpcy5vbk1lc3NhZ2VIYW5kbGVycy5ldmVudHMgPSB7fTtcbiAgICB9XG5cbiAgICBwcm90ZWN0ZWQgb25NZXNzYWdlQ2FsbGJhY2soZXZlbnQ6IE1lc3NhZ2VFdmVudCkge1xuICAgICAgICBjb25zdCBieXRlcyA9IEFycmF5LmZyb20obmV3IFVpbnQ4QXJyYXkoZXZlbnQuZGF0YSkpXG4gICAgICAgIGNvbnN0IGNvZGUgPSBieXRlc1swXTtcblxuICAgICAgICBpZiAoY29kZSA9PT0gUHJvdG9jb2wuSk9JTl9ST09NKSB7XG4gICAgICAgICAgICBsZXQgb2Zmc2V0ID0gMTtcblxuICAgICAgICAgICAgdGhpcy5zZXJpYWxpemVySWQgPSB1dGY4UmVhZChieXRlcywgb2Zmc2V0KTtcbiAgICAgICAgICAgIG9mZnNldCArPSB1dGY4TGVuZ3RoKHRoaXMuc2VyaWFsaXplcklkKTtcblxuICAgICAgICAgICAgLy8gSW5zdGFudGlhdGUgc2VyaWFsaXplciBpZiBub3QgbG9jYWxseSBhdmFpbGFibGUuXG4gICAgICAgICAgICBpZiAoIXRoaXMuc2VyaWFsaXplcikge1xuICAgICAgICAgICAgICAgIGNvbnN0IHNlcmlhbGl6ZXIgPSBnZXRTZXJpYWxpemVyKHRoaXMuc2VyaWFsaXplcklkKVxuICAgICAgICAgICAgICAgIHRoaXMuc2VyaWFsaXplciA9IG5ldyBzZXJpYWxpemVyKCk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGlmIChieXRlcy5sZW5ndGggPiBvZmZzZXQgJiYgdGhpcy5zZXJpYWxpemVyLmhhbmRzaGFrZSkge1xuICAgICAgICAgICAgICAgIHRoaXMuc2VyaWFsaXplci5oYW5kc2hha2UoYnl0ZXMsIHsgb2Zmc2V0IH0pO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICB0aGlzLmhhc0pvaW5lZCA9IHRydWU7XG4gICAgICAgICAgICB0aGlzLm9uSm9pbi5pbnZva2UoKTtcblxuICAgICAgICAgICAgLy8gYWNrbm93bGVkZ2Ugc3VjY2Vzc2Z1bGwgSk9JTl9ST09NXG4gICAgICAgICAgICB0aGlzLmNvbm5lY3Rpb24uc2VuZChbUHJvdG9jb2wuSk9JTl9ST09NXSk7XG5cbiAgICAgICAgfSBlbHNlIGlmIChjb2RlID09PSBQcm90b2NvbC5FUlJPUikge1xuICAgICAgICAgICAgY29uc3QgaXQ6IGRlY29kZS5JdGVyYXRvciA9IHsgb2Zmc2V0OiAxIH07XG5cbiAgICAgICAgICAgIGNvbnN0IGNvZGUgPSBkZWNvZGUubnVtYmVyKGJ5dGVzLCBpdCk7XG4gICAgICAgICAgICBjb25zdCBtZXNzYWdlID0gZGVjb2RlLnN0cmluZyhieXRlcywgaXQpO1xuXG4gICAgICAgICAgICB0aGlzLm9uRXJyb3IuaW52b2tlKGNvZGUsIG1lc3NhZ2UpO1xuXG4gICAgICAgIH0gZWxzZSBpZiAoY29kZSA9PT0gUHJvdG9jb2wuTEVBVkVfUk9PTSkge1xuICAgICAgICAgICAgdGhpcy5sZWF2ZSgpO1xuXG4gICAgICAgIH0gZWxzZSBpZiAoY29kZSA9PT0gUHJvdG9jb2wuUk9PTV9EQVRBX1NDSEVNQSkge1xuICAgICAgICAgICAgY29uc3QgaXQgPSB7IG9mZnNldDogMSB9O1xuXG4gICAgICAgICAgICBjb25zdCBjb250ZXh0OiBDb250ZXh0ID0gKHRoaXMuc2VyaWFsaXplci5nZXRTdGF0ZSgpIGFzIGFueSkuY29uc3RydWN0b3IuX2NvbnRleHQ7XG4gICAgICAgICAgICBjb25zdCB0eXBlID0gY29udGV4dC5nZXQoZGVjb2RlLm51bWJlcihieXRlcywgaXQpKTtcblxuICAgICAgICAgICAgY29uc3QgbWVzc2FnZTogU2NoZW1hID0gbmV3ICh0eXBlIGFzIGFueSkoKTtcbiAgICAgICAgICAgIG1lc3NhZ2UuZGVjb2RlKGJ5dGVzLCBpdCk7XG5cbiAgICAgICAgICAgIHRoaXMuZGlzcGF0Y2hNZXNzYWdlKHR5cGUsIG1lc3NhZ2UpO1xuXG4gICAgICAgIH0gZWxzZSBpZiAoY29kZSA9PT0gUHJvdG9jb2wuUk9PTV9TVEFURSkge1xuICAgICAgICAgICAgYnl0ZXMuc2hpZnQoKTsgLy8gZHJvcCBgY29kZWAgYnl0ZVxuICAgICAgICAgICAgdGhpcy5zZXRTdGF0ZShieXRlcyk7XG5cbiAgICAgICAgfSBlbHNlIGlmIChjb2RlID09PSBQcm90b2NvbC5ST09NX1NUQVRFX1BBVENIKSB7XG4gICAgICAgICAgICBieXRlcy5zaGlmdCgpOyAvLyBkcm9wIGBjb2RlYCBieXRlXG4gICAgICAgICAgICB0aGlzLnBhdGNoKGJ5dGVzKTtcblxuICAgICAgICB9IGVsc2UgaWYgKGNvZGUgPT09IFByb3RvY29sLlJPT01fREFUQSkge1xuICAgICAgICAgICAgY29uc3QgaXQ6IGRlY29kZS5JdGVyYXRvciA9IHsgb2Zmc2V0OiAxIH07XG5cbiAgICAgICAgICAgIGNvbnN0IHR5cGUgPSAoZGVjb2RlLnN0cmluZ0NoZWNrKGJ5dGVzLCBpdCkpXG4gICAgICAgICAgICAgICAgPyBkZWNvZGUuc3RyaW5nKGJ5dGVzLCBpdClcbiAgICAgICAgICAgICAgICA6IGRlY29kZS5udW1iZXIoYnl0ZXMsIGl0KTtcblxuICAgICAgICAgICAgY29uc3QgbWVzc2FnZSA9IChieXRlcy5sZW5ndGggPiBpdC5vZmZzZXQpXG4gICAgICAgICAgICAgICAgPyBtc2dwYWNrLmRlY29kZShldmVudC5kYXRhLCBpdC5vZmZzZXQpXG4gICAgICAgICAgICAgICAgOiB1bmRlZmluZWQ7XG5cbiAgICAgICAgICAgIHRoaXMuZGlzcGF0Y2hNZXNzYWdlKHR5cGUsIG1lc3NhZ2UpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHJvdGVjdGVkIHNldFN0YXRlKGVuY29kZWRTdGF0ZTogbnVtYmVyW10pOiB2b2lkIHtcbiAgICAgICAgdGhpcy5zZXJpYWxpemVyLnNldFN0YXRlKGVuY29kZWRTdGF0ZSk7XG4gICAgICAgIHRoaXMub25TdGF0ZUNoYW5nZS5pbnZva2UodGhpcy5zZXJpYWxpemVyLmdldFN0YXRlKCkpO1xuICAgIH1cblxuICAgIHByb3RlY3RlZCBwYXRjaChiaW5hcnlQYXRjaDogbnVtYmVyW10pIHtcbiAgICAgICAgdGhpcy5zZXJpYWxpemVyLnBhdGNoKGJpbmFyeVBhdGNoKTtcbiAgICAgICAgdGhpcy5vblN0YXRlQ2hhbmdlLmludm9rZSh0aGlzLnNlcmlhbGl6ZXIuZ2V0U3RhdGUoKSk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBkaXNwYXRjaE1lc3NhZ2UodHlwZTogc3RyaW5nIHwgbnVtYmVyIHwgdHlwZW9mIFNjaGVtYSwgbWVzc2FnZTogYW55KSB7XG4gICAgICAgIGNvbnN0IG1lc3NhZ2VUeXBlID0gdGhpcy5nZXRNZXNzYWdlSGFuZGxlcktleSh0eXBlKTtcblxuICAgICAgICBpZiAodGhpcy5vbk1lc3NhZ2VIYW5kbGVycy5ldmVudHNbbWVzc2FnZVR5cGVdKSB7XG4gICAgICAgICAgICB0aGlzLm9uTWVzc2FnZUhhbmRsZXJzLmVtaXQobWVzc2FnZVR5cGUsIG1lc3NhZ2UpO1xuXG4gICAgICAgIH0gZWxzZSBpZiAodGhpcy5vbk1lc3NhZ2VIYW5kbGVycy5ldmVudHNbJyonXSkge1xuICAgICAgICAgICAgdGhpcy5vbk1lc3NhZ2VIYW5kbGVycy5lbWl0KCcqJywgdHlwZSwgbWVzc2FnZSk7XG5cbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGNvbnNvbGUud2Fybihgb25NZXNzYWdlIG5vdCByZWdpc3RlcmVkIGZvciB0eXBlICcke3R5cGV9Jy5gKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHByaXZhdGUgZ2V0TWVzc2FnZUhhbmRsZXJLZXkodHlwZTogc3RyaW5nIHwgbnVtYmVyIHwgdHlwZW9mIFNjaGVtYSk6IHN0cmluZyB7XG4gICAgICAgIHN3aXRjaCAodHlwZW9mKHR5cGUpKSB7XG4gICAgICAgICAgICAvLyB0eXBlb2YgU2NoZW1hXG4gICAgICAgICAgICBjYXNlIFwiZnVuY3Rpb25cIjogcmV0dXJuIGAkJHsodHlwZSBhcyB0eXBlb2YgU2NoZW1hKS5fdHlwZWlkfWA7XG5cbiAgICAgICAgICAgIC8vIHN0cmluZ1xuICAgICAgICAgICAgY2FzZSBcInN0cmluZ1wiOiByZXR1cm4gdHlwZTtcblxuICAgICAgICAgICAgLy8gbnVtYmVyXG4gICAgICAgICAgICBjYXNlIFwibnVtYmVyXCI6IHJldHVybiBgaSR7dHlwZX1gO1xuXG4gICAgICAgICAgICBkZWZhdWx0OiB0aHJvdyBuZXcgRXJyb3IoXCJpbnZhbGlkIG1lc3NhZ2UgdHlwZS5cIik7XG4gICAgICAgIH1cbiAgICB9XG5cbn1cbiJdfQ==